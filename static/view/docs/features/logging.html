<script>
    setPageTitle("Logging");
    app.navPage = "docs";
</script>
<include name="component/header"></include>
<div id="appContainer">
    <section class="doc-container">
        <article class="section-content pad">
            <h1>Logging</h1>
            <p>
                You can configure Sisk to write access and error logs automatically. It is possible to define log
                rotation, format and frequency.
            </p>
            <p>
                The <a href="/spec/Sisk.Core.Http.LogStream">LogStream</a> class provides an asynchronous way of writing
                logs and keeping them in an awaitable write queue.
            </p>
            <p>
                In this article we will show you how to configure logging for your application.
            </p>
            <section>
                <h2 id="file-based-access-logs">
                    File based access logs
                </h2>
                <p>
                    Logs to files open the file, write the line text, and then close the file for every line written.
                    This
                    procedure was adopted to maintain write security in the logs.
                </p>
                <pre><code class="language-cs">Router router = new Router();
HttpServerConfiguration config = new HttpServerConfiguration();

config.ListeningHosts.Add(new ListeningHost("localhost", 5555, router));
config.AccessLogsStream = new LogStream("logs/access.log");</code></pre>
                <p>
                    The above code will write all incoming requests to the <code>logs/access.log</code> file.
                    Note that, the file is created automatically if it does not exist, however the folder before it does
                    not. In this case, it
                    will be necessary to create the <code>logs</code> folder.
                </p>
            </section>
            <section>
                <h2 id="stream-based-access-logs">
                    Stream based logging
                </h2>
                <p>
                    You can write log files to TextWriter objects instances, such as <code>Console.Out</code>, by
                    passing an
                    TextWriter object in the constructor:
                </p>
                <pre><code class="language-cs">config.AccessLogsStream = new LogStream(Console.Out);</code></pre>
                <p>
                    For every message written in the stream-based log, the <code>TextWriter.Flush()</code> method is
                    called.
                </p>
            </section>
            <section>
                <h2 id="formatting-access-logs">
                    Access log formatting
                </h2>
                <p>
                    You can customize the access log format by predefined variables. Consider the following line:
                </p>
                <pre><code class="language-cs">config.AccessLogsFormat = "%dd/%dmm/%dy %tH:%ti:%ts %tz %ls %ri %rs://%ra%rz%rq [%sc %sd] %lin -> %lou in %lmsms [%{user-agent}]";</code></pre>
                <p>
                    It will write an message like:
                </p>
                <pre>29/mar./2023 15:21:47 -0300 Executed ::1 http://localhost:5555/ [200 OK] 689B -> 707B in 84ms [Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/111.0.0.0 Safari/537.36]</pre>
                <p>
                    You can format your log file by the format described by the table:
                </p>
                <table>
                    <thead>
                        <th>Variable</th>
                        <th>Description</th>
                        <th>Example</th>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                %dd
                            </td>
                            <td>
                                The current timestamp's day, in 00 format.
                            </td>
                            <td>
                                25
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %dm
                            </td>
                            <td>
                                The current timestamp's month, in 00 format.
                            </td>
                            <td>
                                03
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %dmm
                            </td>
                            <td>
                                The current timestamp's month, in abreviated name format.
                            </td>
                            <td>
                                mar.
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %dmmm
                            </td>
                            <td>
                                The current timestamp's month, in full name format.
                            </td>
                            <td>
                                March
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %dy
                            </td>
                            <td>
                                The current timestamp's year, in 0000 format.
                            </td>
                            <td>
                                2023
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %th
                            </td>
                            <td>
                                The current timestamp's hour, in 12-hours format.
                            </td>
                            <td>
                                03
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %tH
                            </td>
                            <td>
                                The current timestamp's hour, in 24-hours format.
                            </td>
                            <td>
                                15
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %ti
                            </td>
                            <td>
                                The current timestamp's minutes, in 00 format.
                            </td>
                            <td>
                                25
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %ts
                            </td>
                            <td>
                                The current timestamp's seconds, in 00 format.
                            </td>
                            <td>
                                32
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %tm
                            </td>
                            <td>
                                The current timestamp's millisecond, in 000 format.
                            </td>
                            <td>
                                633
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %tz
                            </td>
                            <td>
                                The current timezone difference, in +/- 0000 format.
                            </td>
                            <td>
                                +0300<br>
                                -0500<br>
                                +0000
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %ri
                            </td>
                            <td>
                                The requesting user IP address (may be IPv4 or IPv6).
                            </td>
                            <td>
                                192.168.0.1
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %rs
                            </td>
                            <td>
                                The requesting user URL scheme.
                            </td>
                            <td>
                                https<br>
                                http
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %ra
                            </td>
                            <td>
                                The requesting user URL authority.
                            </td>
                            <td>
                                my.contorso.com:8080
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %rh
                            </td>
                            <td>
                                The requesting user URL host.
                            </td>
                            <td>
                                my.contorso.com
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %rp
                            </td>
                            <td>
                                The requesting user URL port.
                            </td>
                            <td>
                                8080
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %rz
                            </td>
                            <td>
                                The requesting user URL absolute path.
                            </td>
                            <td>
                                /index.html
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %rq
                            </td>
                            <td>
                                The requesting user URL query string.
                            </td>
                            <td>
                                ?foo=bar&aaa=bbb
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %sc
                            </td>
                            <td>
                                The response status code, in 000 format.
                            </td>
                            <td>
                                404
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %sd
                            </td>
                            <td>
                                The response status description.
                            </td>
                            <td>
                                Not Found
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %lin
                            </td>
                            <td>
                                The incoming request content size, in an human readable form.
                            </td>
                            <td>
                                12,5kb
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %lou
                            </td>
                            <td>
                                The outcoming response content size, in an human readable form.
                            </td>
                            <td>
                                65,8kb
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %lms
                            </td>
                            <td>
                                The server processing time of the request and deliver of the response, in milliseconds
                                format (000).
                            </td>
                            <td>
                                18
                            </td>
                        </tr>
                        <tr>
                            <td>
                                %{header}
                            </td>
                            <td>
                                Gets the value of an HTTP header, where <code>header</code> is the header name, or an
                                empty value if the header ins't present. This field is case-insensitive.
                            </td>
                            <td>
                                %{user-agent}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </section>
            <section>
                <h2 id="rotating-logs">
                    Rotating logs
                </h2>
                <blockquote>
                    <p>
                        <b>Tip:</b>
                    </p>
                    <p>
                        This function is only available with the Sisk.ServiceProvider package.
                    </p>
                </blockquote>
                <p>
                    You can configure the HTTP server to rotate the log files to a compressed .gz file when they reach a
                    certain size. The size is checked periodically by the limiar you define.
                </p>
                <pre><code class="language-cs">config.AccessLogsStream = new LogStream("access.log");

var rotater = new RotatingLogPolicy(config.AccessLogsStream);
rotater.Configure(1024 * 1024, TimeSpan.FromHours(6));</code></pre>
                <p>
                    The above code will check every six hours if the LogStream's file has reached it's 1MB limit. If so,
                    the file is compressed to an .gz file and it then <code>access.log</code> is cleaned.
                </p>
                <p>
                    During this process, writing to the file is locked until the file is compressed and cleaned. All
                    lines that enter to be written in this period will be in a queue waiting for the end of compression.
                </p>
                <p>
                    This function only works with file-based LogStreams.
                </p>
            </section>
            <section>
                <h2 id="error-logging">
                    Error logging
                </h2>
                <p>
                    When a server is not throwing errors to the debugger, it forwards the errors to log writing when
                    there are any. You can configure error writing with:
                </p>
                <pre><code class="language-cs">config.ThrowExceptions = false;
config.ErrorsLogsStream = new LogStream("error.log");</code></pre>
                <p>
                    This property will only write something to the log if the error is not captured by the callback or
                    the <a href="/spec/Sisk.Core.Routing.Router.CallbackErrorHandler">Router.CallbackErrorHandler</a>
                    property.
                </p>
                <p>
                    The error written by the server always writes the date and time, the request headers (not the body),
                    the error trace, and the inner exception trace, if theres any.
                </p>
            </section>
        </article>
        <include name="component/doc-nav"></include>
    </section>
</div>