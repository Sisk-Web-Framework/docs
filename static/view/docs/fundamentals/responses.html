<script>
    setPageTitle("Requests");
    app.navPage = "docs";
</script>
<include name="component/header"></include>
<div id="appContainer">
    <section class="doc-container">
        <article class="section-content pad">
            <h1 id="responses">Responses</h1>
            <p>Responses represent objects that are HTTP responses to HTTP requests. They are sent by the server to the
                client as an indication of the request for a resource, page, document, file or other object.</p>
            <p>An HTTP response is formed up of status, headers and content.</p>
            <p>In this document, we will teach you how to architect HTTP responses with Sisk.</p>
            <h2 id="setting-an-http-status">Setting an HTTP status</h2>
            <p>The HTTP status list is the same since HTTP/1.0, and Sisk supports all of them. </p>
            <pre><code class="lang-cs">
                HttpResponse res = new HttpResponse();
                res.Status = System.Net.HttpStatusCode.Accepted; // 202
            </code></pre>
            <p>You can see the full list of available HttpStatusCode <a href="https://learn.microsoft.com/pt-br/dotnet/api/system.net.httpstatuscode">here</a>.</p>
            <h2 id="setting-body-and-content-type">Setting body and content-type</h2>
            <p>Sisk supports native .NET content objects to send body in responses. You can use the <a href="https://learn.microsoft.com/pt-br/dotnet/api/system.net.http.stringcontent">StringContent</a>
                class to send a JSON response for example:</p>
            <pre><code class="lang-cs">
                HttpResponse res = new HttpResponse();
                res.Content = new StringContent(myJson, Encoding.UTF8, "application/json");
            </code></pre>
            <p>You can ignore setting the <code>Content-Length</code> header as it&#39;s automatically calculated in the
                server infrastructure. Whenever you send an content length header, it will be ignored by the server and
                it will use the real content length based in the Content property length in bytes.</p>
            <h2 id="setting-response-headers">Setting response headers</h2>
            <p>You can add, edit or remove headers you&#39;re sending in the response. The example below shows how to
                send an redirect response to the client.</p>
            <pre><code class="lang-cs">
                HttpResponse res = new HttpResponse();
                res.Status = System.Net.HttpStatusCode.Moved;
                res.Headers.Add("Location", "/login");
            </code></pre>
            <h2 id="easily-setting-cookies">Easily setting cookies</h2>
            <p>Sisk has methods that facilitate the definition of cookies in the client. Cookies set by this method are
                already URL encoded and fit the RFC-6265 standard.</p>
            <pre><code class="lang-cs">
                HttpResponse res = new HttpResponse();
                res.SetCookie("cookie-name", "cookie-value");
            </code></pre>
            <p>There are other <a href="/spec/Sisk.Core.Http.HttpResponse.SetCookie(string-string-DateTime-TimeSpan-string-string-bool-bool-string)">more
                    complete versions</a> of the same <a href="/spec/Sisk.Core.Http.HttpResponse.SetCookie(string-string)">SetCookie</a> method.</p>
            <h2 id="sending-response-in-chunks">Sending response in chunks</h2>
            <p>You can set the transfer encoding to chunked to send large responses.</p>
            <pre><code class="lang-cs">
                HttpResponse res = new HttpResponse();
                res.SendChunked = true;
            </code></pre>
            <p>
                When using chunked-encoding, the Content-Length header is automatically omitted.
            </p>
            <h2 id="sending-an-file">Sending an file</h2>
            <p>
                This example teaches how to send an binary content by HTTP server response. You can use this to serve
                images, files and other binary content.
            </p>
            <p>
                The example below reads the file, loads it into memory and sends the payload. This example is simple
                and can be useful for serving small files.
            </p>
            <pre><code class="lang-cs"><span class="hljs-keyword">
                byte[] myMusicAlbum = File.ReadAllBytes("my-music.zip");

                HttpResponse res = new HttpResponse();
                res.SendChunked = true;
                res.Status = System.Net.HttpStatusCode.OK;
                res.Content = new ByteArrayContent(myMusicAlbum);
                res.Headers.Add("Content-Type", "application/zip"); // override the ByteArrayContent headers
            </code></pre>
            <p>
                This another example opens an read-only stream for the file, copies the stream to the response output
                stream and doens't loads the entire file in the memory. This can be useful to serving medium or big
                files.
            </p>
            <pre><code class="lang-cs">
                // gets the response output stream
                var responseStream = request.GetResponseStream();
                var fileStream = File.OpenRead("my-big-file.zip");

                // sets the streaming mode to use chunked-encoding
                responseStream.SendChunked = true;
                responseStream.SetStatus(200);
                responseStream.AppendHeader("Content-Type", contentType);

                // copies the file stream to the response output stream
                fileStream.CopyTo(responseStream.ResponseStream);

                // closes the stream
                return responseStream.Close();
            </code></pre>
            <p>
                This example shows how to stream a video through the HTTP server
                so that you can browse the video in the browser and send parts of it.
            </p>
            <pre><code class="lang-cs">
                Stream fs = File.OpenRead("shrek-movie.mp4");
                HttpResponse res = new HttpResponse();

                // defines the allocating chunk size for the video in bytes
                int chunkSize = 60000;
                int rangeStart = 0;

                // verify if the client send the Range header and parses it.
                // note that this example only gets the initial range from the
                // header and thus doens't support multiple ranges in the header.
                string? rangeHeader = request.Headers["Range"];
                if (rangeHeader?.Contains("bytes") == true)
                {
                    rangeHeader = rangeHeader.Substring(rangeHeader.IndexOf('=') + 1);
                    rangeHeader = rangeHeader.Substring(0, rangeHeader.IndexOf('-'));
                    if (rangeHeader != "")
                    {
                        rangeStart = Int32.Parse(rangeHeader);
                    }
                }

                int rangeEnd = ((int)Math.Min(fs.Length, chunkSize + rangeStart)) - 1;

                // the streaming content must be served as 206 Partial Content
                res.SendChunked = true;
                res.Status = System.Net.HttpStatusCode.PartialContent;
                res.Headers.Add("Content-Type", "video/mp4");
                res.Headers.Add("Content-Range", $"bytes {rangeStart}-{rangeEnd}/{fs.Length}");

                // copies the video part to the chunk
                byte[] readBuffer = new byte[chunkSize];
                fs.Position = rangeStart;
                fs.Read(readBuffer, 0, chunkSize);

                // serves the chunk
                res.Content = new ByteArrayContent(readBuffer);
                return res;
            </code></pre>
        </article>
        <include name="component/doc-nav"></include>
    </section>
</div>